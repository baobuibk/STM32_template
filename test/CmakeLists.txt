# ==========================================
# CMakeLists.txt trong thư mục test/
# Là file cha quản lý cả host_test và native_test
# ==========================================
cmake_minimum_required(VERSION 3.20)

# Bật hệ thống testing của CMake
enable_testing()

# ---- Tuỳ chọn điều khiển build ----
option(BUILD_HOST_TEST "Build and run host-based tests (Unity + GCC)" ON)
option(BUILD_NATIVE_TEST "Build and run native tests (for embedded/native simulation)" OFF)

message(STATUS "=== Configuring test modules ===")
message(STATUS "BUILD_HOST_TEST:   ${BUILD_HOST_TEST}")
message(STATUS "BUILD_NATIVE_TEST: ${BUILD_NATIVE_TEST}")

# ---- Thêm subdirectory tương ứng ----
if(BUILD_HOST_TEST)
    add_subdirectory(host_test)
endif()

if(BUILD_NATIVE_TEST)
    add_subdirectory(native_test)
endif()

# ---- Tổng hợp test targets tiện lợi ----
# Nếu cả hai loại test đều tồn tại, ta tạo target tiện chạy chung
if(TARGET host_tests OR TARGET native_tests)
    add_custom_target(run_all_tests
        COMMENT "Run all enabled tests"
    )
    if(TARGET host_tests)
        add_dependencies(run_all_tests host_tests)
        add_custom_command(TARGET run_all_tests POST_BUILD
            COMMAND host_tests
            COMMENT "Running host tests...")
    endif()

    if(TARGET native_tests)
        add_dependencies(run_all_tests native_tests)
        add_custom_command(TARGET run_all_tests POST_BUILD
            COMMAND native_tests
            COMMENT "Running native tests...")
    endif()
endif()
