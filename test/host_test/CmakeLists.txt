# CMake cho tests (host-based, dùng GCC/Clang)
cmake_minimum_required(VERSION 3.20)

if(CMAKE_CROSSCOMPILING)
    set(CMAKE_C_COMPILER ${MINGW_PATH})
    enable_language(C)
    set(CMAKE_FIND_ROOT_PATH_MODE_PROGRAM NEVER)
    set(CMAKE_FIND_ROOT_PATH_MODE_LIBRARY ONLY)
    set(CMAKE_FIND_ROOT_PATH_MODE_INCLUDE ONLY)
    message(STATUS "Using host GCC: ${CMAKE_C_COMPILER}")
endif()

# # Build Unity như static library (nếu chưa có target 'unity')
if(NOT TARGET unity)
    add_library(unity STATIC
        ${CMAKE_SOURCE_DIR}/tools/Unity/src/unity.c
        ${CMAKE_SOURCE_DIR}/tools/Unity/extras/fixture/src/unity_fixture.c
        ${CMAKE_SOURCE_DIR}/tools/Unity/extras/memory/src/unity_memory.c
    )
    target_include_directories(unity PUBLIC 
        ${CMAKE_SOURCE_DIR}/tools/Unity/src
        ${CMAKE_SOURCE_DIR}/tools/Unity/extras/fixture/src # Unity Fixture headers
        ${CMAKE_SOURCE_DIR}/tools/Unity/extras/memory/src/ # Unity Memory headers
        )
    target_compile_options(unity PRIVATE -Wall -g)
endif()

# ----------------------------
# Tạo executable cho host tests
# ----------------------------

set(OSAL_SRC_FILES
  ${CMAKE_SOURCE_DIR}/src/M4_MiddleWares/osal/src/windows/osal.c
)

target_sources(${PROJECT_UNIT_TEST_WINDOWS} PRIVATE
    ${OSAL_SRC_FILES}
    test_runner.c
    M0_SysApp/test_main_app.c
    # Thêm file test khác: test_temp_module.c, test_hal_mock.c, ...
    # Có thể thêm mã nguồn cần kiểm thử (phiên bản không phụ thuộc hardware)
    # ../src/M0_SysApp/temp_module.c
)

# Include paths
target_include_directories(${PROJECT_UNIT_TEST_WINDOWS} PRIVATE
    ${CMAKE_SOURCE_DIR}/tools/Unity/src        # Unity headers
    ${CMAKE_SOURCE_DIR}/tools/Unity/extras/fixture/src # Unity Fixture headers
    ${CMAKE_SOURCE_DIR}/tools/Unity/extras/memory/src/ # Unity Memory headers
    ${CMAKE_SOURCE_DIR}/src/M0_SysApp          # Headers từ app thực tế
    ${CMAKE_SOURCE_DIR}/src/M4_MiddleWares/osal/include
    ${CMAKE_SOURCE_DIR}/src/M4_MiddleWares/osal/src/windows
    ${CMAKE_CURRENT_SOURCE_DIR}                # Cho test files
)

# Link Unity library (static)
target_link_libraries(${PROJECT_UNIT_TEST_WINDOWS} PRIVATE
     unity
     winmm)

# Compiler options cho host (debug-friendly)
target_compile_options(${PROJECT_UNIT_TEST_WINDOWS} PRIVATE -Wall -Wextra -g -O0)

# ----------------------------
# Đăng ký test với CTest
# ----------------------------
enable_testing()
message(STATUS "unit_tests COMMAND ${PROJECT_UNIT_TEST_WINDOWS}")
add_test(NAME unit_tests COMMAND ${PROJECT_UNIT_TEST_WINDOWS})

# Set properties: Chạy với verbose output từ Unity
set_tests_properties(unit_tests PROPERTIES
    WORKING_DIRECTORY ${CMAKE_CURRENT_BINARY_DIR}
)

